---
title: "Terraformã§Athenaã‚’æ§‹ç¯‰ã—ã¦ã¿ãŸ"
emoji: "ğŸ“‘"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [Terraform, Athena, AWS]
published: false
---

Hayatoã§ã™ï¼
ä»Šå›ã¯Terraformã§Amazon Athenaã‚’æ§‹ç¯‰ã™ã‚‹æ‰‹é †ã«ã¤ã„ã¦æ›¸ã„ã¦ã„ã“ã†ã¨æ€ã„ã¾ã™ã€‚

Terraformã¨ã¯
-
Terraformã¯ã€HashiCorpãŒé–‹ç™ºã—ãŸInfrastructure as Code (IaC)ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚
ã‚¤ãƒ³ãƒ•ãƒ©ã®æ§‹æˆã‚’ã‚³ãƒ¼ãƒ‰ã§å®šç¾©ã—ã€è‡ªå‹•çš„ã«ãƒ—ãƒ­ãƒ“ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°ã€ç®¡ç†ã™ã‚‹ã®ã«å½¹ç«‹ã¡ã¾ã™ã€‚
https://developer.hashicorp.com/terraform

AWSãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰S3ãƒã‚±ãƒƒãƒˆã‚’ä½œã£ãŸã‚ŠEC2ã‚’èµ·å‹•ã•ã›ãŸã‚Šã™ã‚‹ã“ã¨ã¯ã‚‚ã¡ã‚ã‚“ã§ãã¾ã™ãŒã€ãƒªã‚½ãƒ¼ã‚¹ã®æ•°ãŒå¢—ãˆã‚‹ã¨ã€æ“ä½œãƒŸã‚¹ã‚„è¨­å®šã®æŠœã‘æ¼ã‚ŒãŒèµ·ãã‚„ã™ããªã‚Šã€æ‰‹é–“ã‚‚å¢—ãˆã¦ã—ã¾ã„ã¾ã™ã€‚
Terraformã‚’ä½¿ãˆã°ã€ãƒªã‚½ãƒ¼ã‚¹ã‚’ã‚³ãƒ¼ãƒ‰ã§ç®¡ç†ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ãŸã‚ã€æ§‹ç¯‰ä½œæ¥­ã‚’è‡ªå‹•åŒ–ãƒ»æ¨™æº–åŒ–ã§ãã€å†ç¾æ€§ã®é«˜ã„ç’°å¢ƒã‚’æ‰‹æ—©ãå®‰å…¨ã«ä½œæˆã§ãã¾ã™ã€‚

Amazon Athenaã¨ã¯
-
Amazon Athena ã¯ã€Amazon S3 ã«ä¿å­˜ã•ã‚ŒãŸæ§‹é€ åŒ–ãƒ»åŠæ§‹é€ åŒ–ãƒ‡ãƒ¼ã‚¿ï¼ˆä¾‹ï¼šCSVã€JSONã€Parquetã€ORC ãªã©ï¼‰ã«å¯¾ã—ã¦ã€æ¨™æº–çš„ãª SQLã‚’ä½¿ã£ã¦ç›´æ¥ã‚¯ã‚¨ãƒªã‚’å®Ÿè¡Œã—ã€ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹ã§ãƒ‡ãƒ¼ã‚¿åˆ†æã‚’è¡Œãˆã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã§ã™ã€‚
https://docs.aws.amazon.com/ja_jp/athena/latest/ug/what-is.html

AWSæ§‹æˆ
-
ä»Šå›ã®ã‚±ãƒ¼ã‚¹ã§ã¯æ—¢ã«S3ã«ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ãŒä¿å­˜ã•ã‚Œã¦ã„ã¦ã€ãã®åˆ†æãŒå¿…è¦ã«ãªã£ãŸã€ã¨ã„ã†ã‚±ãƒ¼ã‚¹ã‚’æƒ³å®šã—ã¦ä¸‹è¨˜ã®ã‚ˆã†ãªæ§‹æˆã«ãªã£ã¦ã„ã¾ã™ã€‚


ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ
-
ä½œæˆã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã¯ä»¥ä¸‹ã«ãªã‚Šã¾ã™ã€‚
ã‚³ãƒ¼ãƒ‰ã‚’ãã®ã¾ã¾ä½¿ç”¨ã™ã‚‹éš›ã¯ã€ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åŒã˜ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«é…ç½®ã—ã¦ãã ã•ã„ã€‚
â€»äº‹å‰ä½œæ¥­ã¨ã—ã¦ã€S3ãƒã‚±ãƒƒãƒˆã‚’1ã¤äº‹å‰ã«ä½œæˆã—ã¦ãã ã•ã„ã€‚
ä½œæˆã—ãŸS3ãƒã‚±ãƒƒãƒˆã«åˆ†æã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜ã—ã¦ãã ã•ã„ã€‚
- main.tf
ã“ã“ã§AWSãƒªã‚½ãƒ¼ã‚¹ã‚’å®šç¾©ã—ã¾ã™
```
# terraform configuration
terraform {
  required_providers {
    aws = {
      source = "hashicorp/aws"
    }
  }
}
# providerã®æŒ‡å®š
provider "aws" {
  profile = "terraform"
  region  = "ap-northeast-1"
}

# ã‚¯ã‚¨ãƒªçµæœä¿å­˜ç”¨S3
resource "aws_s3_bucket" "result_bucket" {
  bucket        = "result-athena-training"
  force_destroy = true
}

# ãƒ‘ãƒ–ãƒªãƒƒã‚¯ã‚¢ã‚¯ã‚»ã‚¹ã‚’ãƒ–ãƒ­ãƒƒã‚¯
resource "aws_s3_bucket_public_access_block" "result_bucket" {
  bucket                  = aws_s3_bucket.result_bucket.id
  block_public_acls       = true
  block_public_policy     = true
  ignore_public_acls      = true
  restrict_public_buckets = true
}

# Athena
# ãƒ¯ãƒ¼ã‚¯ã‚°ãƒ«ãƒ¼ãƒ—ã®ä½œæˆ
resource "aws_athena_workgroup" "test" {
  name = "test"
  configuration {
    result_configuration {
      output_location = "s3://${aws_s3_bucket.result_bucket.bucket}/query-results/"
    }
  }
  force_destroy = true
}

# DBã®ä½œæˆ
resource "aws_athena_database" "db" {
  name          = "db_log"
  bucket        = aws_s3_bucket.result_bucket.id
  force_destroy = true
}

# ãƒ†ãƒ¼ãƒ–ãƒ«ã®ä½œæˆ
resource "aws_athena_named_query" "create_table" {
  name     = "create_sample_table"
  database = aws_athena_database.db.id
  query    = file("./create-table.sql.tpl")
  workgroup = aws_athena_workgroup.test.name  
}

```
- create-table.sql.tpl
ã‚¯ã‚¨ãƒªã‚’è¨˜è¼‰ã—ã¾ã™
```
CREATE EXTERNAL TABLE IF NOT EXISTS db_log.sample_table (
    `id` int,
    `name` string,
    `number` int,
    `position` string
)
ROW FORMAT SERDE 'org.openx.data.jsonserde.JsonSerDe'
STORED AS TEXTFILE
LOCATION 's3://log-athena-training/'
;
```
- .tool-versions
.tool-versionsã¯asdfã§ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†ã‚’ã—ã¦ã„ã‚‹éƒ½åˆä¸Šä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚
asdfã‚’ä½¿ç”¨ã—ã¦ã„ãªã„éš›ã¯ä¸è¦ã«ãªã‚Šã¾ã™ã€‚
```
terraform 1.10.5
```
å®Ÿè¡Œçµæœ
-
ä¸‹è¨˜ã®ã‚³ãƒãƒ³ãƒ‰ã‚’é †ç•ªã«å®Ÿè¡Œã—ã¦ãã ã•ã„
```
terraform init

terraform plan

terraform apply
```
plan, applyã¯å®Ÿè¡Œå¾Œã€yesã¨å…¥åŠ›ã—ã¦Enterã‚’ã—ã¦ãã ã•ã„ã€‚
```
Apply complete! Resources: 5 added, 0 changed, 0 destroyed.
```
ä¸Šè¨˜ã®ã‚ˆã†ã«æˆåŠŸã—ãŸã‚‰ã€AWSã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ã¿ã¾ã—ã‚‡ã†ï¼


æ§‹ç¯‰ãƒ»å®Ÿè¡Œã§ããŸã‚‰æœ€å¾Œã«ä½œæˆã—ãŸãƒªã‚½ãƒ¼ã‚¹ã‚’å‰Šé™¤ã—ã¾ã—ã‚‡ã†
```
terraform destroy
```
ã¾ãŸã€äº‹å‰ã«ä½œæˆã—ãŸS3ãƒã‚±ãƒƒãƒˆã‚‚ä¸è¦ã§ã—ãŸã‚‰å‰Šé™¤ã—ã¾ã—ã‚‡ã†ã€‚

æœ€å¾Œã«
-
æœ€å¾Œã¾ã§ãŠèª­ã¿ã„ãŸã ãã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸã€‚
ä»Šå›ã¯Terraformã§Athenaã‚’æ§‹ç¯‰ã—ã¦ã¿ã¾ã—ãŸãŒã€ä»–ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚‚æ§‹ç¯‰ã—ã¦ã¿ã‚ˆã†ã¨æ€ã„ã¾ã™ï¼